
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>MASH analysis pipeline with data-driven prior matrices &#8212; ADSP-FG Project</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Univariate fine-mapping workflows" href="../../fine_mapping/univariate_fine_mapping.html" />
    <link rel="prev" title="A multivariate EBNM approach for mixture multivariate distribution estimate" href="mixture_prior.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/xqtl_wf.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">ADSP-FG Project</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../README.html">
   ADSP-FG xQTL protocol
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../xqtl_protocol_demo.html">
   Illustration of xQTL protocol
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Command Generator
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../commands_generator/bulk_expression_commands.html">
   RNA-seq calling and QC
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../commands_generator/eQTL_analysis_commands.html">
   Bulk RNA-seq eQTL analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../data_preprocessing/reference_data.html">
   Reference data standardization
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Molecular Phenotypes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../molecular_phenotypes/bulk_expression.html">
   RNA-seq expression
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/calling/RNA_calling.html">
     Quantifying expression from RNA-seq data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/QC/bulk_expression_QC.html">
     Sample level RNA-seq quality control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/QC/bulk_expression_normalization.html">
     Bulk RNA-seq counts normalization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../molecular_phenotypes/scnuc_expression.html">
   scRNA-seq expression calling
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../molecular_phenotypes/apa.html">
   Alternative polyadenylation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/calling/apa_calling.html">
     APA Calling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../molecular_phenotypes/methylation.html">
   Methylation
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/calling/methylation_calling.html">
     Quantification of methylation data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../molecular_phenotypes/splicing.html">
   Alternative splicing from RNA-seq data
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/calling/splicing_calling.html">
     Quantifying alternative splicing from RNA-seq data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../molecular_phenotypes/QC/splicing_normalization.html">
     Normalization and phenotype table generation for splicingQTL analysis
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Pre-processing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../data_preprocessing/genotype_preprocessing.html">
   Genotype data preprocessing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/genotype/VCF_QC.html">
     Genotype VCF file quality control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/genotype/GWAS_QC.html">
     Genotype PLINK file quality control
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/genotype/PCA.html">
     Principal component analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/genotype/GRM.html">
     Genomic relationship matrices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/genotype/genotype_formatting.html">
     Genotype data formatting
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../data_preprocessing/phenotype_preprocessing.html">
   Phenotype data preprocessing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/phenotype/gene_annotation.html">
     Gene coordinate annotation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/phenotype/phenotype_formatting.html">
     Phenotype data formatting
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../data_preprocessing/covariate_preprocessing.html">
   Covariate data preprocessing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/covariate/PEER_factor.html">
     Factor analysis using PEER
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/covariate/BiCV_factor.html">
     Factor analysis using Bi-Cross validation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data_preprocessing/covariate/covariate_formatting.html">
     Covariate data formatting
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  QTL Association Testing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../association_scan/cisQTL_scan.html">
   cisQTL analysis workflows
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../association_scan/TensorQTL/TensorQTL.html">
     TensorQTL QTL association testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../association_scan/APEX/APEX.html">
     APEX QTL association testing
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../association_scan/transQTL_scan.html">
   transQTL analysis workflows
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multivariate Analysis
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../METAL_pipeline.html">
   Meta-analysis with METAL
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../METAL/METAL.html">
     Meta-analysis with METAL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../MASH_pipeline.html">
   Multivariate association with MASH
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="fastqtl_to_mash.html">
     eQTL summary statistics formatting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mixture_prior.html">
     A multivariate EBNM approach for mixture multivariate distribution estimate
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     MASH analysis pipeline with data-driven prior matrices
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistical Fine-mapping
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../fine_mapping/univariate_fine_mapping.html">
   Univariate fine-mapping workflows
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fine_mapping/SuSiE/SuSiE_RSS.html">
     Fine-mapping with SuSiE RSS model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../fine_mapping/SuSiE/SuSiE.html">
     Fine-mapping with SuSiE model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fine_mapping/multivariate_fine_mapping.html">
   Multivariate fine-mapping workflows
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multi-omics integration
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../integrative_analysis/colocalization.html">
   QTL and GWAS Colocalization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../integrative_analysis/COLOC/fastenloc.html">
     Colocalization with FastENLOC
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../integrative_analysis/COLOC/mvenloc.html">
     Multivariate SuSiE and ENLOC model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../integrative_analysis/functional_annotation.html">
   Functional annotation integration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../integrative_analysis/enrichment/gwas_enrichment.html">
     Enrichment analysis: TORUS and GREGOR
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../integrative_analysis/enrichment/ldsc.html">
     Stratified LD Score Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../integrative_analysis/SuSiE_Ann/polyfun.html">
     Fine-mapping with PolyFun
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Utilities
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/summary_stats_standardizer.html">
   Overview of design
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../misc/rds_to_vcf.html">
   Summary statistics in VCF format
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Supported by <a href="https://www.nia.nih.gov/research/ad-genetics">NIH NIA</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/code/multivariate/MASH/mashr.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        
        <a class="issues-button"
            href="https://github.com/cumc/xqtl-pipeline/issues/new?title=Issue%20on%20page%20%2Fcode/multivariate/MASH/mashr.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cumc/xqtl-pipeline/edit/gh-pages/code/multivariate/MASH/mashr.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-overview">
   Data overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparing-mash-input">
   Preparing MASH input
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#some-data-integrity-check">
     Some data integrity check
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-job-summary">
     Data &amp; job summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multivariate-adaptive-shrinkage-mash-analysis-of-eqtl-data">
   Multivariate adaptive shrinkage (MASH) analysis of eQTL data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-parameter-settings">
     Global parameter settings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#command-interface">
     Command interface
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#factor-analyses">
   Factor analyses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimate-residual-variance">
     Estimate residual variance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-mash-priors">
     Compute MASH priors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mashr-mixture-model-fitting">
   <code class="docutils literal notranslate">
    <span class="pre">
     mashr
    </span>
   </code>
   mixture model fitting
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-posterior-computations">
     Optional posterior computations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-mash-posteriors">
   Compute MASH posteriors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#posterior-results">
     Posterior results
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="mash-analysis-pipeline-with-data-driven-prior-matrices">
<h1>MASH analysis pipeline with data-driven prior matrices<a class="headerlink" href="#mash-analysis-pipeline-with-data-driven-prior-matrices" title="Permalink to this headline">¶</a></h1>
<p>This notebook is a pipeline written in SoS to run <code class="docutils literal notranslate"><span class="pre">flashr</span> <span class="pre">+</span> <span class="pre">mashr</span></code> for multivariate analysis described in Urbut et al (2019). This pipeline was last applied to analyze GTEx V8 eQTL data, although it can be used as is to perform similar multivariate analysis for other association studies.</p>
<p><em>Version: 2021.02.28 by Gao Wang and Yuxin Zou</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">revisions</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <table class="revision_table">
        <tr>
        <th>Revision</th>
        <th>Author</th>
        <th>Date</th>
        <th>Message</th>
        <tr>
        <tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/2570aa68b8c8c1a543c8a98d1cf486575736cbe1/mashr_flashr_workflow.ipynb"><span class="revision_id">2570aa6<span></a></td>
<td>Gao Wang</td>
<td>2019-10-03</td>
<td>Update and improve data preprocessing pipelines</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/3a02d2d7635f52aa1e81687479a8b782cfdf19a4/mashr_flashr_workflow.ipynb"><span class="revision_id">3a02d2d<span></a></td>
<td>Gao Wang</td>
<td>2019-07-11</td>
<td>Update mashr version</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/3de66784e79d0b11a9f995ff11fdc7a4fbe12223/mashr_flashr_workflow.ipynb"><span class="revision_id">3de6678<span></a></td>
<td>Gao Wang</td>
<td>2019-02-05</td>
<td>Add corshrink pipeline implementation</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/80e89a86f9ce380b7f30dc4dd64ef4ec632ef2d0/mashr_flashr_workflow.ipynb"><span class="revision_id">80e89a8<span></a></td>
<td>Gao Wang</td>
<td>2019-01-28</td>
<td>Add a note on HPC job submission</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/982a1b4cc4d8a14a77587fd55a825bf9ef00391e/mashr_flashr_workflow.ipynb"><span class="revision_id">982a1b4<span></a></td>
<td>Gao Wang</td>
<td>2019-01-28</td>
<td>Implement new $\hat{V}$ estimation method (with Yuxin Zou)</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/515e86951d09a0f2c1d4d3efde43882bfb75427e/mashr_flashr_workflow.ipynb"><span class="revision_id">515e869<span></a></td>
<td>Gao Wang</td>
<td>2018-11-22</td>
<td>Add a prompt for empty input posterior</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/ba9b20e5d705b20cda80826989293022452c3101/mashr_flashr_workflow.ipynb"><span class="revision_id">ba9b20e<span></a></td>
<td>Gao Wang</td>
<td>2018-11-22</td>
<td>Add posterior calculation for input 'strong' set</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/49494706a413999201362e72c9e20cbb95351be2/mashr_flashr_workflow.ipynb"><span class="revision_id">4949470<span></a></td>
<td>Gao Wang</td>
<td>2018-11-22</td>
<td>Fix mashr null correlation estimate interface</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/6145b3366b7850eac2e10bdd69634f6482e3359f/mashr_flashr_workflow.ipynb"><span class="revision_id">6145b33<span></a></td>
<td>Gao Wang</td>
<td>2018-11-21</td>
<td>Add --optmethod to configure convex optimization method to use</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/485381c8483bc4b770f8648b325a6386cd1a68d9/mashr_flashr_workflow.ipynb"><span class="revision_id">485381c<span></a></td>
<td>Gao Wang</td>
<td>2018-11-20</td>
<td>Fix mixSQP package name #2</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/c587791ce58a5d393782466ba762a32544edcf0e/mashr_flashr_workflow.ipynb"><span class="revision_id">c587791<span></a></td>
<td>Gao Wang</td>
<td>2018-11-20</td>
<td>Use the first cran release of mixSQP in default flashr workflow</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/092e20680cce52f594dd7fb95ee2c6b8ea85f036/mashr_flashr_workflow.ipynb"><span class="revision_id">092e206<span></a></td>
<td>Gao Wang</td>
<td>2018-09-24</td>
<td>Minor edits to documentation</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/4a5f2b78f94619f5759448e1fd0a9ba8fb600cb0/mashr_flashr_workflow.ipynb"><span class="revision_id">4a5f2b7<span></a></td>
<td>Gao Wang</td>
<td>2018-09-24</td>
<td>Add notes to results</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/e653d39708c6ba5b96da27472aed2896232814a8/mashr_flashr_workflow.ipynb"><span class="revision_id">e653d39<span></a></td>
<td>Gao Wang</td>
<td>2018-09-24</td>
<td>Configure posterior computation resources</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/ca56229760bd274d193689dbe9bf3efea8103b65/mashr_flashr_workflow.ipynb"><span class="revision_id">ca56229<span></a></td>
<td>Gao Wang</td>
<td>2018-09-23</td>
<td>Add posterior computation for input data-set</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/7db5500fd4549d39a21360fbcbf689bf5576094f/mashr_flashr_workflow.ipynb"><span class="revision_id">7db5500<span></a></td>
<td>Gao Wang</td>
<td>2018-09-23</td>
<td>Notes on GTEx V8 data conversion steps</td></tr><tr><td><a target="_blank" href="git@github.com:stephenslab/gtexresults/blob/68d2571e7d6284d02ac42d53e901968546298251/mashr_flashr_workflow.ipynb"><span class="revision_id">68d2571<span></a></td>
<td>Gao Wang</td>
<td>2018-05-30</td>
<td>Add mashr_flashr workflow</td></tr></table></div></div>
</div>
<section id="data-overview">
<h2>Data overview<a class="headerlink" href="#data-overview" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">fastqtl</span></code> summary statistics data were obtained from dbGaP (data on CRI at UChicago Genetic Medicine). It has 49 tissues. [more description to come]</p>
</section>
<section id="preparing-mash-input">
<h2>Preparing MASH input<a class="headerlink" href="#preparing-mash-input" title="Permalink to this headline">¶</a></h2>
<p>Using an established workflow (which takes 33hrs to run on a cluster system as configured by <code class="docutils literal notranslate"><span class="pre">midway2.yml</span></code>; see inside <code class="docutils literal notranslate"><span class="pre">fastqtl_to_mash.ipynb</span></code> for a note on computing environment),</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT_DIR</span><span class="o">=/</span><span class="n">project</span><span class="o">/</span><span class="n">compbio</span><span class="o">/</span><span class="n">GTEx_dbGaP</span><span class="o">/</span><span class="n">GTEx_Analysis_2017</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">05</span><span class="n">_v8</span><span class="o">/</span><span class="n">eqtl</span><span class="o">/</span><span class="n">GTEx_Analysis_v8_eQTL_all_associations</span>
<span class="n">JOB_OPT</span><span class="o">=</span><span class="s2">&quot;-c midway2.yml -q midway2&quot;</span>
<span class="n">sos</span> <span class="n">run</span> <span class="n">workflows</span><span class="o">/</span><span class="n">fastqtl_to_mash</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="nb">list</span> <span class="err">$</span><span class="n">INPUT_DIR</span><span class="o">/</span><span class="n">FastQTLSumStats</span><span class="o">.</span><span class="n">list</span> <span class="o">--</span><span class="n">common</span><span class="o">-</span><span class="n">suffix</span> <span class="s2">&quot;.allpairs.txt&quot;</span> <span class="err">$</span><span class="n">JOB_OPT</span>
</pre></div>
</div>
<p>As a result of command above I obtained the “mashable” data-set in the same format <a class="reference external" href="https://stephenslab.github.io/gtexresults/gtexdata.html">as described here</a>.</p>
<section id="some-data-integrity-check">
<h3>Some data integrity check<a class="headerlink" href="#some-data-integrity-check" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Check if I get the same number of groups (genes) at the end of HDF5 data conversion:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">zcat</span> <span class="n">Whole_Blood</span><span class="o">.</span><span class="n">allpairs</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">gz</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">f1</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">u</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="mi">20316</span>
<span class="err">$</span> <span class="n">h5ls</span> <span class="n">Whole_Blood</span><span class="o">.</span><span class="n">allpairs</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">h5</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="mi">20315</span>
</pre></div>
</div>
<p>The results agreed on Whole Blood sample (the original data has a header thus one line more than the H5 version). We should be good (since the pipeline reported success for all other files).</p>
</section>
<section id="data-job-summary">
<h3>Data &amp; job summary<a class="headerlink" href="#data-job-summary" title="Permalink to this headline">¶</a></h3>
<p>The command above took 33 hours on UChicago RCC <code class="docutils literal notranslate"><span class="pre">midway2</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MW</span><span class="p">]</span> <span class="n">cat</span> <span class="n">FastQTLSumStats</span><span class="o">.</span><span class="n">log</span>
<span class="mi">39832</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">39832</span> <span class="n">groups</span> <span class="n">merged</span><span class="err">!</span>
</pre></div>
</div>
<p>So we have a total of 39832 genes (union of 49 tissues).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MW</span><span class="p">]</span> <span class="n">cat</span> <span class="n">FastQTLSumStats</span><span class="o">.</span><span class="n">portable</span><span class="o">.</span><span class="n">log</span>
<span class="mi">15636</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">39832</span> <span class="n">groups</span> <span class="n">extracted</span><span class="err">!</span>
</pre></div>
</div>
<p>We have 15636 groups without missing data in any tissue. This will be used to train the MASH model.</p>
<p>The “mashable” data file is <code class="docutils literal notranslate"><span class="pre">FastQTLSumStats.mash.rds</span></code>, 124Mb serialized R file.</p>
</section>
</section>
<section id="multivariate-adaptive-shrinkage-mash-analysis-of-eqtl-data">
<h2>Multivariate adaptive shrinkage (MASH) analysis of eQTL data<a class="headerlink" href="#multivariate-adaptive-shrinkage-mash-analysis-of-eqtl-data" title="Permalink to this headline">¶</a></h2>
<p>Below is a “blackbox” implementation of the <code class="docutils literal notranslate"><span class="pre">mashr</span></code> eQTL workflow – blackbox in the sense that you can run this pipeline as an executable, without thinking too much about it, if you see your problem fits our GTEx analysis scheme. However when reading it as a notebook it is a good source of information to help developing your own <code class="docutils literal notranslate"><span class="pre">mashr</span></code> analysis procedures.</p>
<p>Since the submission to biorxiv of Urbut 2017 we have improved implementation of MASH algorithm and made a new R package, <a class="reference external" href="https://github.com/stephenslab/mashr"><code class="docutils literal notranslate"><span class="pre">mashr</span></code></a>. Major improvements compared to Urbut 2019 are:</p>
<ol class="simple">
<li><p>Faster computation of likelihood and posterior quantities via matrix algebra tricks and a C++ implementation.</p></li>
<li><p>Faster computation of MASH mixture via convex optimization.</p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">SFA</span></code> with <code class="docutils literal notranslate"><span class="pre">FLASH</span></code>, a new sparse factor analysis method to generate prior covariance candidates.</p></li>
<li><p>Improve estimate of residual variance <span class="math notranslate nohighlight">\(\hat{V}\)</span>.</p></li>
</ol>
<p>At this point, the input data have already been converted from the original eQTL summary statistics to a format convenient for analysis in MASH, as a result of running the data conversion pipeline in <code class="docutils literal notranslate"><span class="pre">fastqtl_to_mash.ipynb</span></code>.</p>
<p>Example command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">JOB_OPT</span><span class="o">=</span><span class="s2">&quot;-j 8&quot;</span>
<span class="c1">#JOB_OPT=&quot;-c midway2.yml -q midway2&quot;</span>
sos run workflows/mashr_flashr_workflow.ipynb mash <span class="nv">$JOB_OPT</span> <span class="c1"># --data ... --cwd ... --vhat ...</span>
</pre></div>
</div>
<p><strong>FIXME: add comments on submitting jobs to HPC. Here we use the UChicago RCC cluster but other users can similarly configure their computating system to run the pipeline on HPC.</strong></p>
<section id="global-parameter-settings">
<h3>Global parameter settings<a class="headerlink" href="#global-parameter-settings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">cwd</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;./mashr_flashr_workflow_output&#39;</span><span class="p">)</span>
<span class="c1"># Input summary statistics data</span>
<span class="kn">parameter:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s2">&quot;fastqtl_to_mash_output/FastQTLSumStats.mash.rds&quot;</span><span class="p">)</span>
<span class="c1"># Prefix of output files. If not specified, it will derive it from data.</span>
<span class="c1"># If it is specified, for example, `--output-prefix AnalysisResults`</span>
<span class="c1"># It will save output files as `{cwd}/AnalysisResults*`.</span>
<span class="kn">parameter:</span> <span class="n">output_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1"># Exchangable effect (EE) or exchangable z-scores (EZ)</span>
<span class="kn">parameter:</span> <span class="n">effect_model</span> <span class="o">=</span> <span class="s1">&#39;EZ&#39;</span>
<span class="c1"># Identifier of $\hat{V}$ estimate file</span>
<span class="c1"># Options are &quot;identity&quot;, &quot;simple&quot;, &quot;mle&quot;, &quot;vhat_corshrink_xcondition&quot;, &quot;vhat_simple_specific&quot;</span>
<span class="kn">parameter:</span> <span class="n">vhat</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span>
<span class="kn">parameter:</span> <span class="n">mixture_components</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flash&#39;</span><span class="p">,</span> <span class="s1">&#39;flash_nonneg&#39;</span><span class="p">,</span> <span class="s1">&#39;pca&#39;</span><span class="p">,</span><span class="s2">&quot;canonical&quot;</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">container</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">cwd</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_prefix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">output_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">:</span><span class="s2">bn</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">prior_data</span> <span class="o">=</span> <span class="n">file_target</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">effect_model</span><span class="si">}</span><span class="s2">.prior.rds&quot;</span><span class="p">)</span>
<span class="n">vhat_data</span> <span class="o">=</span> <span class="n">file_target</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">effect_model</span><span class="si">}</span><span class="s2">.V_</span><span class="si">{</span><span class="n">vhat</span><span class="si">}</span><span class="s2">.rds&quot;</span><span class="p">)</span>
<span class="n">mash_model</span> <span class="o">=</span> <span class="n">file_target</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">effect_model</span><span class="si">}</span><span class="s2">.V_</span><span class="si">{</span><span class="n">vhat</span><span class="si">}</span><span class="s2">.mash_model.rds&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sort_uniq</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="command-interface">
<h3>Command interface<a class="headerlink" href="#command-interface" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="n">sos</span> <span class="n">run</span> <span class="n">mashr_flashr_workflow</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>usage: sos run mashr_flashr_workflow.ipynb
               [workflow_name | -t targets] [options] [workflow_options]
  workflow_name:        Single or combined workflows defined in this script
  targets:              One or more targets to generate
  options:              Single-hyphen sos parameters (see &quot;sos run -h&quot; for details)
  workflow_options:     Double-hyphen workflow-specific parameters

Workflows:
  flash
  flash_nonneg
  pca
  vhat_identity
  vhat_simple
  vhat_mle
  vhat_corshrink_xcondition
  vhat_simple_specific
  prior
  mash
  posterior

Global Workflow Options:
  --cwd mashr_flashr_workflow_output (as path)
  --data fastqtl_to_mash_output/FastQTLSumStats.mash.rds (as path)
                        Input summary statistics data
  --output-prefix &#39;&#39;
                        Prefix of output files. If not specified, it will derive
                        it from data. If it is specified, for example,
                        `--output-prefix AnalysisResults` It will save output
                        files as `{cwd}/AnalysisResults*`.
  --effect-model EZ
                        Exchangable effect (EE) or exchangable z-scores (EZ)
  --vhat mle
                        Identifier of $\hat{V}$ estimate file Options are
                        &quot;identity&quot;, &quot;simple&quot;, &quot;mle&quot;,
                        &quot;vhat_corshrink_xcondition&quot;, &quot;vhat_simple_specific&quot;
  --mixture-components flash flash_nonneg pca (as list)

Sections
  flash:                Perform FLASH analysis with non-negative factor
                        constraint (time estimate: 20min)
  flash_nonneg:         Perform FLASH analysis with non-negative factor
                        constraint (time estimate: 20min)
  pca:
    Workflow Options:
      --npc 3 (as int)
                        Number of components in PCA analysis for prior set to 3
                        as in mash paper
  vhat_identity:        V estimate: &quot;identity&quot; method
  vhat_simple:          V estimate: &quot;simple&quot; method (using null z-scores)
  vhat_mle:             V estimate: &quot;mle&quot; method
    Workflow Options:
      --n-subset 6000 (as int)
                        number of samples to use
      --max-iter 6 (as int)
                        maximum number of iterations
  vhat_corshrink_xcondition_1: Estimate each V separately via corshrink
    Workflow Options:
      --util-script /project/mstephens/gtex/scripts/SumstatQuery.R (as path)
                        Utility script
      --gene-list . (as path)
                        List of genes to analyze
  vhat_simple_specific_1: Estimate each V separately via &quot;simple&quot; method
    Workflow Options:
      --util-script /project/mstephens/gtex/scripts/SumstatQuery.R (as path)
                        Utility script
      --gene-list . (as path)
                        List of genes to analyze
  vhat_corshrink_xcondition_2, vhat_simple_specific_2: Consolidate Vhat into one
                        file
    Workflow Options:
      --gene-list . (as path)
                        List of genes to analyze
  prior:                Compute data-driven / canonical prior matrices (time
                        estimate: 2h ~ 12h for ~30 49 by 49 matrix mixture)
  mash_1:               Fit MASH mixture model (time estimate: &lt;15min for 70K by
                        49 matrix)
  mash_2:               Compute posterior for the &quot;strong&quot; set of data as in
                        Urbut et al 2017. This is optional because most of the
                        time we want to apply the MASH model learned on much
                        larger data-set.
    Workflow Options:
      --[no-]compute-posterior (default to True)
                        default to True; use --no-compute-posterior to disable
                        this
  posterior:            Apply posterior calculations
    Workflow Options:
      --mash-model  path(f&quot;{vhat_data:n}.mash_model.rds&quot;)

      --posterior-input  paths()

      --posterior-vhat-files  paths()

      --data-table-name &#39;&#39;
                        eg, if data is saved in R list as data$strong, then when
                        you specify `--data-table-name strong` it will read the
                        data as readRDS(&#39;{_input:r}&#39;)$strong
      --bhat-table-name Bhat
      --shat-table-name Shat
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="factor-analyses">
<h2>Factor analyses<a class="headerlink" href="#factor-analyses" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform FLASH analysis with non-negative factor constraint (time estimate: 20min)</span>
<span class="p">[</span><span class="n">flash</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.flash.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;2h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stdout&#39;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">remove_singleton</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">in</span> <span class="n">mixture_components</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">},</span> <span class="n">output_model</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{_output:n}</span><span class="s2">.model.rds&quot;</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform FLASH analysis with non-negative factor constraint (time estimate: 20min)</span>
<span class="p">[</span><span class="n">flash_nonneg</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.flash_nonneg.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;2h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stdout&#39;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="s2">&quot;nonneg&quot;</span><span class="p">,</span> <span class="n">remove_singleton</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">in</span> <span class="n">mixture_components</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">},</span> <span class="n">output_model</span><span class="o">=</span><span class="s2">&quot;$</span><span class="si">{_output:n}</span><span class="s2">.model.rds&quot;</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">pca</span><span class="p">]</span>
<span class="c1"># Number of components in PCA analysis for prior</span>
<span class="c1"># set to 3 as in mash paper</span>
<span class="kn">parameter:</span> <span class="n">npc</span> <span class="o">=</span> <span class="mi">2</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.pca.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stdout&#39;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_pca</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">npc</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">canonical</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.canonical.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">n</span><span class="si">}</span><span class="s1">.stdout&#39;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_canonical</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<section id="estimate-residual-variance">
<h3>Estimate residual variance<a class="headerlink" href="#estimate-residual-variance" title="Permalink to this headline">¶</a></h3>
<p>FIXME: add some narratives here explaining what we do in each method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># V estimate: &quot;identity&quot; method</span>
<span class="p">[</span><span class="n">vhat_identity</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">.V_identity.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;2h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">)),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># V estimate: &quot;simple&quot; method (using null z-scores)</span>
<span class="p">[</span><span class="n">vhat_simple</span><span class="p">]</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">.V_simple.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;2h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">estimate_null_correlation_simple</span><span class="p">(</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">))</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">vhat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># V estimate: &quot;mle&quot; method</span>
<span class="p">[</span><span class="n">vhat_mle</span><span class="p">]</span>
<span class="c1"># number of samples to use</span>
<span class="kn">parameter:</span> <span class="n">n_subset</span> <span class="o">=</span> <span class="mi">6000</span>
<span class="c1"># maximum number of iterations</span>
<span class="kn">parameter:</span> <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">6</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span><span class="p">,</span> <span class="n">prior_data</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">.V_mle.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="c1"># choose random subset</span>
    <span class="nb">set</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">subset</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">n_subset</span><span class="p">},</span> <span class="n">nrow</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">)))</span>
    <span class="n">random</span><span class="o">.</span><span class="n">subset</span> <span class="o">=</span> <span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">subset</span><span class="p">,],</span> <span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">subset</span><span class="p">,],</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="c1"># estimate V mle</span>
    <span class="n">vhatprior</span> <span class="o">=</span> <span class="n">mash_estimate_corr_em</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">subset</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">r</span><span class="p">}),</span> <span class="n">max_iter</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">max_iter</span><span class="p">})</span>
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">vhat</span><span class="err">$</span><span class="n">V</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">vhat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">vhat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate each V separately via corshrink</span>
<span class="p">[</span><span class="n">vhat_corshrink_xcondition_1</span><span class="p">]</span>
<span class="c1"># Utility script</span>
<span class="kn">parameter:</span> <span class="n">util_script</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;/project/mstephens/gtex/scripts/SumstatQuery.R&#39;</span><span class="p">)</span>
<span class="c1"># List of genes to analyze</span>
<span class="kn">parameter:</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="n">path</span><span class="p">()</span>

<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">gene_list</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please specify valid path for --gene-list&#39;</span><span class="p">)</span>
<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">util_script</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">util_script</span><span class="p">)),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please specify valid path for --util-script&#39;</span><span class="p">)</span>
<span class="n">genes</span> <span class="o">=</span> <span class="n">sort_uniq</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gene_list</span><span class="si">:</span><span class="s1">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)])</span>


<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;CorShrink&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span><span class="p">,</span> <span class="n">for_each</span> <span class="o">=</span> <span class="s1">&#39;genes&#39;</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">bnn</span><span class="si">}</span><span class="s1">_V_corshrink_</span><span class="si">{</span><span class="n">_genes</span><span class="si">}</span><span class="s1">.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;3m&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;3G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">source</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">util_script</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">CorShrink_sum</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">z_thresh</span> <span class="o">=</span> <span class="mi">2</span><span class="p">){</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
      <span class="n">dat</span> <span class="o">&lt;-</span> <span class="n">GetSS</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="s2">&quot;z-score&quot;</span>
      <span class="n">max_absz</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
      <span class="n">nullish</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">max_absz</span> <span class="o">&lt;</span> <span class="n">z_thresh</span><span class="p">)</span>
      <span class="c1"># if (length(nullish) &lt; ncol(z)) {</span>
        <span class="c1"># stop(&quot;not enough null data to estimate null correlation&quot;)</span>
      <span class="c1"># }</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nullish</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">nullish_z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">nullish</span><span class="p">,</span> <span class="p">]</span>  
        <span class="n">mat</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">CorShrink</span><span class="p">::</span><span class="n">CorShrinkData</span><span class="p">(</span><span class="n">nullish_z</span><span class="p">,</span> <span class="n">ash</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mixcompdist</span> <span class="o">=</span> <span class="s2">&quot;halfuniform&quot;</span><span class="p">))</span><span class="err">$</span><span class="n">cor</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Corshrink_sum</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{_genes}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">data</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate each V separately via &quot;simple&quot; method</span>
<span class="p">[</span><span class="n">vhat_simple_specific_1</span><span class="p">]</span>
<span class="c1"># Utility script</span>
<span class="kn">parameter:</span> <span class="n">util_script</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;/project/mstephens/gtex/scripts/SumstatQuery.R&#39;</span><span class="p">)</span>
<span class="c1"># List of genes to analyze</span>
<span class="kn">parameter:</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="n">path</span><span class="p">()</span>

<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">gene_list</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please specify valid path for --gene-list&#39;</span><span class="p">)</span>
<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">util_script</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">util_script</span><span class="p">)),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please specify valid path for --util-script&#39;</span><span class="p">)</span>
<span class="n">genes</span> <span class="o">=</span> <span class="n">sort_uniq</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gene_list</span><span class="si">:</span><span class="s1">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)])</span>

<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;Matrix&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span><span class="p">,</span> <span class="n">for_each</span> <span class="o">=</span> <span class="s1">&#39;genes&#39;</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">bnn</span><span class="si">}</span><span class="s1">_V_simple_</span><span class="si">{</span><span class="n">_genes</span><span class="si">}</span><span class="s1">.rds&#39;</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;3G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">source</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">util_script</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">simple_V</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">z_thresh</span> <span class="o">=</span> <span class="mi">2</span><span class="p">){</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
      <span class="n">dat</span> <span class="o">&lt;-</span> <span class="n">GetSS</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="s2">&quot;z-score&quot;</span>
      <span class="n">max_absz</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
      <span class="n">nullish</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">max_absz</span> <span class="o">&lt;</span> <span class="n">z_thresh</span><span class="p">)</span>
      <span class="c1"># if (length(nullish) &lt; ncol(z)) {</span>
        <span class="c1"># stop(&quot;not enough null data to estimate null correlation&quot;)</span>
      <span class="c1"># }</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nullish</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">nullish_z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">nullish</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">Matrix</span><span class="p">::</span><span class="n">nearPD</span><span class="p">(</span><span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">cov</span><span class="p">(</span><span class="n">nullish_z</span><span class="p">)),</span> <span class="n">conv</span><span class="o">.</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">doSym</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span><span class="err">$</span><span class="n">mat</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">simple_V</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{_genes}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">data</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Consolidate Vhat into one file</span>
<span class="p">[</span><span class="n">vhat_corshrink_xcondition_2</span><span class="p">,</span> <span class="n">vhat_simple_specific_2</span><span class="p">]</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">)</span>
<span class="c1"># List of genes to analyze</span>
<span class="kn">parameter:</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="n">path</span><span class="p">()</span>

<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">gene_list</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Please specify valid path for --gene-list&#39;</span><span class="p">)</span>
<span class="n">genes</span> <span class="o">=</span> <span class="n">paths</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">gene_list</span><span class="si">:</span><span class="s1">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)])</span>


<span class="kn">input:</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s2">nn</span><span class="si">}</span><span class="s2">.V_</span><span class="si">{</span><span class="n">step_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.rds&quot;</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">sapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">genes</span><span class="p">:</span><span class="n">r</span><span class="p">,}),</span> <span class="n">function</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="n">paste0</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">adr</span><span class="p">}),</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="s1">&#39;.rds&#39;</span><span class="p">),</span> <span class="n">USE</span><span class="o">.</span><span class="n">NAMES</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">mclapply</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">i</span><span class="p">){</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">},</span> <span class="n">mc</span><span class="o">.</span><span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">dim</span><span class="p">(</span><span class="n">V</span><span class="p">[[</span><span class="mi">1</span><span class="p">]])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">V</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="k">as</span><span class="o">.</span><span class="n">numeric</span><span class="p">(</span><span class="n">unlist</span><span class="p">(</span><span class="n">V</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">L</span><span class="p">))</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">ar</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-mash-priors">
<h3>Compute MASH priors<a class="headerlink" href="#compute-mash-priors" title="Permalink to this headline">¶</a></h3>
<p>Main reference are our <code class="docutils literal notranslate"><span class="pre">mashr</span></code> vignettes <a class="reference external" href="https://stephenslab.github.io/mashr/articles/eQTL_outline.html">this for mashr eQTL outline</a> and <a class="reference external" href="https://github.com/stephenslab/mashr/blob/master/vignettes/flash_mash.Rmd">this for using FLASH prior</a>.</p>
<p>The outcome of this workflow should be found under <code class="docutils literal notranslate"><span class="pre">./mashr_flashr_workflow_output</span></code> folder (can be configured). File names have pattern <code class="docutils literal notranslate"><span class="pre">*.mash_model_*.rds</span></code>. They can be used to computer posterior for input list of gene-SNP pairs (see next section).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute data-driven / canonical prior matrices (time estimate: 2h ~ 12h for ~30 49 by 49 matrix mixture)</span>
<span class="p">[</span><span class="n">prior</span><span class="p">]</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
<span class="c1"># if vhat method is `mle` it should use V_simple to analyze the data to provide a rough estimate, then later be refined via `mle`.</span>
<span class="kn">input:</span> <span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">vhat_data</span> <span class="k">if</span> <span class="n">vhat</span> <span class="o">!=</span> <span class="s2">&quot;mle&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vhat_data</span><span class="si">:</span><span class="s1">nn</span><span class="si">}</span><span class="s1">.V_simple.rds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">.rds&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mixture_components</span><span class="p">]</span>
<span class="kn">output:</span> <span class="n">prior_data</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">rds_files</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">,})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">vhat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="c1"># setup prior</span>
    <span class="n">U</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">XtX</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">mash_data</span><span class="err">$</span><span class="n">Bhat</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">mash_data</span><span class="err">$</span><span class="n">Bhat</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">(</span><span class="n">mash_data</span><span class="err">$</span><span class="n">Bhat</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">rds_files</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">rds_files</span><span class="p">)])</span> <span class="n">U</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">U</span><span class="o">.</span><span class="n">ed</span> <span class="o">=</span> <span class="n">cov_ed</span><span class="p">(</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="kp">logfile</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">nr</span><span class="p">})</span>
    <span class="c1"># Canonical matrices</span>
    <span class="n">U</span><span class="o">.</span><span class="n">can</span> <span class="o">=</span> <span class="n">cov_canonical</span><span class="p">(</span><span class="n">mash_data</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">ed</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">can</span><span class="p">),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="mashr-mixture-model-fitting">
<h2><code class="docutils literal notranslate"><span class="pre">mashr</span></code> mixture model fitting<a class="headerlink" href="#mashr-mixture-model-fitting" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit MASH mixture model (time estimate: &lt;15min for 70K by 49 matrix)</span>
<span class="p">[</span><span class="n">mash_1</span><span class="p">]</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span><span class="p">,</span> <span class="n">vhat_data</span><span class="p">,</span> <span class="n">prior_data</span>
<span class="kn">output:</span> <span class="n">mash_model</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">V</span><span class="o">=</span><span class="n">vhat</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">mash</span><span class="p">(</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">Ulist</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">outputlevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<section id="optional-posterior-computations">
<h3>Optional posterior computations<a class="headerlink" href="#optional-posterior-computations" title="Permalink to this headline">¶</a></h3>
<p>Additionally provide posterior for the “strong” set in MASH input data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute posterior for the &quot;strong&quot; set of data as in Urbut et al 2017.</span>
<span class="c1"># This is optional because most of the time we want to apply the </span>
<span class="c1"># MASH model learned on much larger data-set.</span>
<span class="p">[</span><span class="n">mash_2</span><span class="p">]</span>
<span class="c1"># default to True; use --no-compute-posterior to disable this</span>
<span class="kn">parameter:</span> <span class="n">compute_posterior</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># input Vhat file for the batch of posterior data</span>
<span class="n">skip_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">compute_posterior</span><span class="p">)</span>
<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
<span class="kn">input:</span> <span class="n">data</span><span class="p">,</span> <span class="n">vhat_data</span><span class="p">,</span> <span class="n">mash_model</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">effect_model</span><span class="si">}</span><span class="s2">.posterior.rds&quot;</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span><span class="p">,</span> <span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">V</span><span class="o">=</span><span class="n">vhat</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">mash_model</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">ar</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">mash_compute_posterior_matrices</span><span class="p">(</span><span class="n">mash_model</span><span class="p">,</span> <span class="n">mash_data</span><span class="p">),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="compute-mash-posteriors">
<h2>Compute MASH posteriors<a class="headerlink" href="#compute-mash-posteriors" title="Permalink to this headline">¶</a></h2>
<p>In the GTEx V6 paper we assumed one eQTL per gene and applied the model learned above to those SNPs. Under that assumption, the input data for posterior calculation will be the <code class="docutils literal notranslate"><span class="pre">dat$strong.*</span></code> matrices.
It is a fairly straightforward procedure as shown in <a class="reference external" href="https://stephenslab.github.io/mashr/articles/eQTL_outline.html">this vignette</a>.</p>
<p>But it is often more interesting to apply MASH to given list of eQTLs, eg, from those from fine-mapping results. In GTEx V8 analysis we obtain such gene-SNP pairs from DAP-G fine-mapping analysis. See <a class="reference external" href="https://stephenslab.github.io/gtex-eqtls/analysis/Independent_eQTL_Results.html">this notebook</a> for how the input data is prepared. The workflow below takes a number of input chunks (each chunk is a list of matrices <code class="docutils literal notranslate"><span class="pre">dat$Bhat</span></code> and <code class="docutils literal notranslate"><span class="pre">dat$Shat</span></code>)
and computes posterior for each chunk. It is therefore suited for running in parallel posterior computation for all gene-SNP pairs, if input data chunks are provided.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JOB_OPT</span><span class="o">=</span><span class="s2">&quot;-c midway2.yml -q midway2&quot;</span>
<span class="n">DATA_DIR</span><span class="o">=/</span><span class="n">project</span><span class="o">/</span><span class="n">compbio</span><span class="o">/</span><span class="n">GTEx_eQTL</span><span class="o">/</span><span class="n">independent_eQTL</span>
<span class="n">sos</span> <span class="n">run</span> <span class="n">workflows</span><span class="o">/</span><span class="n">mashr_flashr_workflow</span><span class="o">.</span><span class="n">ipynb</span> <span class="n">posterior</span> \
    <span class="err">$</span><span class="n">JOB_OPT</span> \
    <span class="o">--</span><span class="n">posterior</span><span class="o">-</span><span class="nb">input</span> <span class="err">$</span><span class="n">DATA_DIR</span><span class="o">/</span><span class="n">DAPG_pip_gt_0</span><span class="mf">.01</span><span class="o">-</span><span class="n">AllTissues</span><span class="o">/</span><span class="n">DAPG_pip_gt_0</span><span class="mf">.01</span><span class="o">-</span><span class="n">AllTissues</span><span class="o">.*.</span><span class="n">rds</span> \
                      <span class="err">$</span><span class="n">DATA_DIR</span><span class="o">/</span><span class="n">ConditionalAnalysis_AllTissues</span><span class="o">/</span><span class="n">ConditionalAnalysis_AllTissues</span><span class="o">.*.</span><span class="n">rds</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply posterior calculations</span>
<span class="p">[</span><span class="n">posterior_1</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">analysis_units</span> <span class="o">=</span> <span class="n">path</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">analysis_units</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
<span class="kn">parameter:</span> <span class="n">mash_model</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">effect_model</span><span class="si">}</span><span class="s2">.V_</span><span class="si">{</span><span class="n">vhat</span><span class="si">}</span><span class="s2">.mash_model.rds&quot;</span><span class="p">)</span>
<span class="kn">parameter:</span> <span class="n">posterior_input</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">posterior_vhat_files</span> <span class="o">=</span> <span class="n">paths</span><span class="p">()</span>
<span class="c1"># eg, if data is saved in R list as data$strong, then</span>
<span class="c1"># when you specify `--data-table-name strong` it will read the data as</span>
<span class="c1"># readRDS(&#39;{_input:r}&#39;)$strong</span>
<span class="kn">parameter:</span> <span class="n">data_table_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="kn">parameter:</span> <span class="n">bhat_table_name</span> <span class="o">=</span> <span class="s1">&#39;bhat&#39;</span>
<span class="kn">parameter:</span> <span class="n">shat_table_name</span> <span class="o">=</span> <span class="s1">&#39;sbhat&#39;</span>
<span class="n">mash_model</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mash_model</span><span class="si">:</span><span class="s2">a</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="c1">##  conditions can be excluded if needs arise. If nothing to exclude keep the default 0</span>
<span class="kn">parameter:</span> <span class="n">exclude_condition</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;3&quot;</span><span class="p">]</span>

<span class="n">skip_if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posterior_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No posterior input data to compute on. Please specify it using --posterior-input.&quot;</span><span class="p">)</span>
<span class="n">fail_if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posterior_vhat_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">posterior_vhat_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">posterior_input</span><span class="p">),</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;length of --posterior-input and --posterior-vhat-files do not agree.&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">posterior_input</span><span class="p">:</span>
    <span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">(),</span> <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Cannot find posterior input file ``</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">``&#39;</span><span class="p">)</span>

<span class="kn">depends:</span> <span class="n">R_library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">),</span> <span class="n">mash_model</span>
<span class="kn">input:</span> <span class="n">posterior_input</span><span class="p">,</span> <span class="n">group_by</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kn">output:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">_input</span><span class="si">:</span><span class="s2">bn</span><span class="si">}</span><span class="s2">.posterior.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;20h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;20G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s1">bn</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span>
    <span class="n">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{_input}</span><span class="s2">&quot;</span><span class="p">)</span><span class="err">$</span><span class="p">{(</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="n">data_table_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">data_table_name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exclude_condition</span><span class="p">)})[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">){</span>
      <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Excluding condition $</span><span class="si">{exclude_condition}</span><span class="s2"> from the analysis&quot;</span><span class="p">))</span>
      <span class="n">data</span><span class="err">$</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">data</span><span class="err">$</span><span class="n">bhat</span><span class="p">[,</span><span class="o">-</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exclude_condition</span><span class="p">)})]</span>
      <span class="n">data</span><span class="err">$</span><span class="n">sbhat</span> <span class="o">=</span> <span class="n">data</span><span class="err">$</span><span class="n">sbhat</span><span class="p">[,</span><span class="o">-</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exclude_condition</span><span class="p">)})]</span>
      <span class="n">data</span><span class="err">$</span><span class="n">Z</span> <span class="o">=</span> <span class="n">data</span><span class="err">$</span><span class="n">Z</span><span class="p">[,</span><span class="o">-</span><span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exclude_condition</span><span class="p">)})]</span>
    <span class="p">}</span>
  
    <span class="n">vhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">&quot;${vhat_data if len(posterior_vhat_files) == 0 else posterior_vhat_files[_index]}&quot;</span><span class="p">)</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="n">mash_set_data</span><span class="p">(</span><span class="n">data</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat_table_name</span><span class="p">},</span> <span class="n">Shat</span><span class="o">=</span><span class="n">data</span><span class="err">$$</span><span class="p">{</span><span class="n">shat_table_name</span><span class="p">},</span> <span class="n">alpha</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="mi">1</span> <span class="k">if</span> <span class="n">effect_model</span> <span class="o">==</span> <span class="s1">&#39;EZ&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">},</span> <span class="n">V</span><span class="o">=</span><span class="n">vhat</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="mf">1E3</span><span class="p">)</span>
    <span class="n">mash_output</span> <span class="o">=</span> <span class="n">mash_compute_posterior_matrices</span><span class="p">(</span><span class="n">readRDS</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{mash_model}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">mash_data</span><span class="p">)</span>
    <span class="n">mash_output</span><span class="err">$</span><span class="n">snps</span> <span class="o">=</span> <span class="n">data</span><span class="err">$</span><span class="n">snps</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">mash_output</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-sos notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">posterior_2</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
<span class="kn">output:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">/mash_output_list&quot;</span>
<span class="kn">python:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;$[ ]&quot;</span><span class="p">,</span> <span class="kp">workdir</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_output</span><span class="si">:</span><span class="s2">n</span><span class="si">}</span><span class="s2">.stdout&quot;</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;#mash_result&quot;</span> <span class="p">:</span>  <span class="p">[</span><span class="err">$</span><span class="p">[</span><span class="n">_input</span><span class="p">:</span><span class="n">ar</span><span class="p">,]]</span> <span class="p">})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;$[_output]&quot;</span><span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="posterior-results">
<h3>Posterior results<a class="headerlink" href="#posterior-results" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>The outcome of the <code class="docutils literal notranslate"><span class="pre">[posterior]</span></code> step should produce a number of serialized R objects <code class="docutils literal notranslate"><span class="pre">*.batch_*.posterior.rds</span></code> (can be loaded to R via <code class="docutils literal notranslate"><span class="pre">readRDS()</span></code>) – I chopped data to batches to take advantage of computing in multiple cluster nodes. It should be self-explanary but please let me know otherwise.</p></li>
<li><p>Other posterior related files are:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*.batch_*.yaml</span></code>: gene-SNP pairs of interest, identified elsewhere (eg. fine-mapping analysis).</p></li>
<li><p>The corresponding univariate analysis summary statistics for gene-SNPs from <code class="docutils literal notranslate"><span class="pre">*.batch_*.yaml</span></code> are extracted and saved to <code class="docutils literal notranslate"><span class="pre">*.batch_*.rds</span></code>, creating input to the <code class="docutils literal notranslate"><span class="pre">[posterior]</span></code> step.</p></li>
<li><p>Note the <code class="docutils literal notranslate"><span class="pre">*.batch_*.stdout</span></code> file documents some SNPs found in fine-mapping results but not found in the original <code class="docutils literal notranslate"><span class="pre">fastqtl</span></code> output.</p></li>
</ol>
</li>
</ol>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "sos"
        },
        kernelOptions: {
            kernelName: "sos",
            path: "./code/multivariate/MASH"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'sos'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="mixture_prior.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">A multivariate EBNM approach for mixture multivariate distribution estimate</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../fine_mapping/univariate_fine_mapping.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Univariate fine-mapping workflows</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The NIH/NIA Alzheimer's Disease Sequencing Project Functional Genomics Consortium<br/>
        
            &copy; Copyright 2021+, ADSP-FG xQTL methods and data integration working group.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>